name: Backend CI Test

on:
  push:
    branches: [ "test" ]
    paths:
      - 'backend/**'

jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write # Required for PR creation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Gets all branches so we can see 'main'

      - name: Lowercase the repo name
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Build Docker Image
        run: docker build -t ghcr.io/${{ env.REPO_LC }}/backend:test ./backend

      # This step creates a Pull Request to merge 'test' into 'main'
      - name: Create PR to main
        if: success()
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: test-sync-branch   # The action creates a temporary branch
          base: main                 # We want to merge INTO main
          title: "Sync Test to Main: Backend Build Passed"
          body: "The backend build on the `test` branch was successful. This PR syncs those changes to `main`."
          # If there are no file changes (e.g. only image build), it won't create a PR.
          # To force a PR even if no files changed, we ensure a "sync" commit:
          commit-message: "chore: sync test to main after successful build"

      - name: Build Failed Notification
        if: failure()
        run: echo "Backend build failed. No PR will be created."
