name: Backend CI Test

on:
  push:
    branches: [ "test" ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-test.yaml'
jobs:
  build-test:
    runs-on: ubuntu-latest

    permissions:
      contents: write
 

    steps:
      #  Checkout code
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      # Lowercase repo name for GHCR
      - name: Lowercase the repo name
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}
      #  Build backend image (test tag)
      - name: Build Docker Image
        run: docker build -t ghcr.io/${{ env.REPO_LC }}/backend:test ./backend

   
    
  # Merge test into main automatically
      - name: Merge test into main
        if: ${{ success() }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin main
          git checkout main
          git merge origin/test --allow-unrelated-histories --no-ff -m "Auto merge test â†’ main (build passed)"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      