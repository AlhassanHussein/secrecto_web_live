name: Frontend CI Test

on:
  push:
    branches: [ "test" ]
    paths:
      - 'frontend/**'

jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # Checkout code from test branch
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      # Lowercase repo name for GHCR compatibility
      - name: Lowercase the repo name
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      # Build frontend Docker image to verify Dockerfile
      - name: Build Frontend Docker Image
        run: docker build -t ghcr.io/${{ env.REPO_LC }}/frontend:test ./frontend

      # Create PR to main if build succeeded (requires manual approval)
      - name: Create PR to main
        if: ${{ success() }}
        id: create_pr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Frontend build passed → Auto PR to main"
          branch: test
          base: main
          title: "Auto PR: Frontend build passed"
          body: |
            ## Frontend Build Successful ✅
            
            This PR is auto-created because the frontend Docker build passed on the test branch.
            
            **Changes:** Frontend updates from test branch
            **Action Required:** DevOps manual review and approval needed before merge
          labels: frontend,auto-pr

      # Log message if build failed
      - name: Build Failed - No PR Created
        if: ${{ failure() }}
        run: echo "❌ Frontend Docker build failed → No PR created. Please fix the Dockerfile and try again."
